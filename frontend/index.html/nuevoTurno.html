<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>SOMEX - Ingreso Nuevo Turno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link href="assets/styles.css" rel="stylesheet">

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>

<body>

  <!-- ========================================================= -->
  <!-- ENCABEZADO SUPERIOR -->
  <!-- ========================================================= -->
  <div class="header-bar">
      <i class="bi bi-arrow-left-circle header-icon" onclick="history.back()"></i>
      <!--<i class="bi bi-arrow-left-circle header-icon"></i>-->
      <h2>Ingreso Nuevo Turno</h2>
      <i id="btnGuardarTurno" class="bi bi-check-circle header-icon"></i>
  </div>

  <div class="container my-4">

    <!-- ========================================================= -->
    <!-- FORMULARIO -->
    <!-- ========================================================= -->
    
    <form id="formTurno">
      <div class="row g-4">

      <div class="col-md-4">
        <label class="form-label">* Cédula</label>
        <input type="text" id="cedula" class="form-control" placeholder="Digite su Cédula" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">* Nombre Completo</label>
        <input type="text" id="nombre" class="form-control" placeholder="Digite Nombre completo" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">* Celular</label>
        <input type="text" id="celular" class="form-control" placeholder="Digite número de celular" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">* Placa</label>
        <input type="text" id="placa" class="form-control" placeholder="Digite placa del vehículo" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">* Tipo vehículo</label>
        <select id="tipo_vehiculo" class="form-select" required>
        <!--<select class="form-select">-->
          <option disabled selected>Seleccionar...</option>
          <option value="mula">Mula</option>
          <option value="camion">Camión</option>
          <option value="tractomula">Tractomula</option>
          <option value="sencillo">Sencillo</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Destino Final</label>
        <input type="text" id="destinoFinal" class="form-control" placeholder="Digite su destino final" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">* Tipo de visita</label>
        <select id="tipoVisita" class="form-select" required>
          <option disabled selected>Seleccionar...</option>
          <option>Producto Terminado</option>
          <option>Materia Prima</option>
          <option>Interno</option>
        </select>
      </div>

    </div>
  </form>

    <!-- ========================================================= -->
    <!-- TABLA DE HISTORIAL -->
    <!-- ========================================================= -->

    <div class="table-responsive mt-4">
      <table class="table table-bordered">
        <thead class="table-header">
          <tr>
            <th>Turno</th>
            <th>Cédula</th>
            <th>Nombre</th>
            <th>Placa</th>
            <th>Celular</th>
            <th>Estado</th>
            <th>Destino Final</th>
            <th>Tipo Visita</th>
          </tr>
        </thead>

        <tbody id="tablaTurnos">
          <!-- Aquí JS insertará filas -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- =============================================== -->
  <!-- LIBRERÍAS EXTERNAS -->
  <!-- =============================================== -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
// ==============================================
// 1. Cargar turnos desde backend real
// ==============================================
async function cargarTurnos() {
    try {
        const resp = await fetch("http://localhost:4000/api/turnos");
        const turnos = await resp.json();
        pintarTabla(turnos);
    } catch (error) {
        console.error("Error cargando turnos:", error);
    }
}

// ==============================================
// 2. Pintar la tabla dinámicamente
// ==============================================
function pintarTabla(turnos) {
    const tbody = document.getElementById("tablaTurnos");
    tbody.innerHTML = "";

    turnos.forEach(t => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${t.numeroTurno}</td>
            <td>${t.cedula}</td>
            <td>${t.nombreCompleto}</td>
            <td>${t.placa}</td>
            <td>${t.celular}</td>
            <td>${t.estado}</td>
            <td>${t.destinoFinal}</td>
            <td>${t.tipoVisita}</td>
        `;

        tbody.appendChild(tr);
    });
}

// ==============================================
// 3. Recargar tabla automáticamente cada 5 segundos
// ==============================================
setInterval(cargarTurnos, 5000);

// ==============================================
// 4. Cargar tabla al abrir la página
// ==============================================
document.addEventListener("DOMContentLoaded", cargarTurnos);

</script>

<!-- =============================================== 
 AQUI PEGAS EL JS DEL BOTON btnGuardarTurno -
=============================================== -->


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.getElementById("btnGuardarTurno").addEventListener("click", async () => {
    const nombre = document.getElementById("nombre").value.trim();
    const placa = document.getElementById("placa").value.trim();
    const cedula = document.getElementById("cedula").value.trim();
    const celular = document.getElementById("celular").value.trim();
    const tipoVehiculo = document.getElementById("tipo_vehiculo").value;
    const destinoFinal = document.getElementById("destinoFinal").value.trim();
    const tipoVisita = document.getElementById("TipoVisita").value;

    // Validar campos obligatorios
    if (!nombre || !placa || !cedula || !celular || !tipoVehiculo || !tipoVisita)
        Swal.fire({
            icon: "warning",
            title: "Campos incompletos",
            text: "Por favor diligencie todos los campos obligatorios."
        });
        return;
    

    try {
        const respBuscar = await fetch(`http://localhost:4000/api/conductores/buscar/${cedula}`);
        let conductor = await respBuscar.json();

        if (!conductor || !conductor.idConductor) {
            const respCrear = await fetch("http://localhost:4000/api/conductores", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    cedula: cedula,
                    nombreCompleto: nombre,
                    celular: celular,
                    placa: placa,
                    tipoVehiculo: tipoVehiculo,
                    destinoFinal: destinoFinal,
                    tipoVisita: tipoVisita
                })
            });
            conductor = await respCrear.json();
        }

        //Crear turno
        const respTurno = await fetch("http://localhost:4000/api/turnos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idConductor: conductor.idConductor })
        });
        const turno = await respTurno.json();

        //Mensaje de éxito
        Swal.fire({
            icon: "success",
            title: "Turno asignado",
            text: `Turno #${turno.numeroTurno} asignado correctamente.`
        });

        // actualizar tabla inmediatamente
        cargarTurnos();

        //Limpiar formulario
        document.getElementById("formTurno").reset();

    } catch (error) {
        console.error(error);
        Swal.fire({
            icon: "error",
            title: "Error",
            text: "Ocurrió un problema al asignar el turno."
        });
    }
});

</script>

</body>
</html>
